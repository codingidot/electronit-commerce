# STEP 19: 부하 테스트 계획 및 수행

## 1. 테스트 목적
- 서비스 성능 및 안정성을 검증하기 위해 부하 상황에서의 시스템 동작 확인
- 병목 구간 확인 및 재고, 쿠폰 발급과 주문 처리 로직의 동시성 검증
- 실제 사용자 수가 많을 경우에도 서비스가 정상적으로 동작하는지 확인

## 2. 테스트 대상
- **쿠폰 발급 API**: `POST /coupons/issue`
  - 선착순 쿠폰 발급 로직 검증
  - 동시 요청 처리 및 경쟁 조건 확인
- **주문 처리 API**: `POST /orders`
  - 상품 재고 차감 및 주문 생성 로직 검증
  - 동시 주문 시 트랜잭션 안정성 및 Redis 기반 순위 업데이트 확인

## 3. 테스트 시나리오
1. **쿠폰 발급 시나리오**
   - 가상 사용자(VU) 1000명 동시 요청
   - 각 사용자 1회 쿠폰 발급 요청
   - 선착순 100명만 성공, 나머지 409 Conflict 응답 예상
2. **주문 처리 시나리오**
   - 쿠폰 발급 시나리오 완료 후 10초 후 시작
   - 가상 사용자(VU) 100명 동시 요청
   - 재고 100개, 주문 수량 1개
   - 재고 부족 시 400/409 응답 발생

## 4. 테스트 스크립트 (k6)

```javascript
import http from "k6/http";
import { group, check, sleep } from "k6";

export const options = {
  scenarios: {
    coupon_issue: {
      executor: "shared-iterations",
      vus: 1000,
      iterations: 1000,
      startTime: "0s",
      exec: "coupon_issue",
    },
    order_test: {
      executor: "shared-iterations",
      vus: 100,
      iterations: 1000,
      startTime: "10s",
      exec: "order_test",
    },
  },
  thresholds: {
    http_req_duration: ["p(99)<1000"],
  },
};

const BASE_URL = "http://localhost:8080";
const SLEEP_DURATION = 0.1;

function couponIssue() {
  group("쿠폰 발급 시나리오", () => {
    let url = `${BASE_URL}/coupons/issue`;
    let userId = __VU;
    let body = JSON.stringify({ userId: userId, couponId: 1 });
    let params = { headers: { "Content-Type": "application/json" } };

    let res = http.post(url, body, params);
    check(res, {
      "쿠폰 발급 성공 (200)": (r) => r.status === 200,
      "쿠폰 발급 실패 (409)": (r) => r.status === 409,
    });
    sleep(SLEEP_DURATION);
  });
}

function orderTest() {
  group("주문 처리 시나리오", () => {
    let url = `${BASE_URL}/orders`;
    let userId = __VU;
    let body = JSON.stringify({ userId: userId, goodsId: 1, count: 1 });
    let params = { headers: { "Content-Type": "application/json" } };

    let res = http.post(url, body, params);
    check(res, {
      "주문 성공 (200)": (r) => r.status === 200,
      "품절 실패 (400/409)": (r) =>
        r.status === 400 || r.status === 409,
    });
    sleep(SLEEP_DURATION);
  });
}

export function coupon_issue() {
  couponIssue();
}

export function order_test() {
  orderTest();
}


## 5. 테스트 수행 결과

### 5.1 쿠폰 발급
- 선착순 100명 성공
- 나머지 900명 실패

### 5.2 주문 처리
- 재고 100개 중 99개 정상 주문
- 재고 부족으로 인한 일부 실패 발생

### 5.3 분석
- 트랜잭션, Redis 멀티락 등 로직 정상 동작 확인
- 실패율은 재고/쿠폰 한계 때문이며 정상 범위
- 일부 응답 시간 6초 이상 → DB/Kafka 처리 지연 가능

## 6. 개선 포인트
- 부하 테스트 목적에 맞게 쿠폰 발급 수량 및 재고를 늘려 테스트
- 성공한 쿠폰 사용자만 주문하도록 스크립트 개선 가능
- Kafka, DB 처리 병목 구간 확인 후 최적화 가능
