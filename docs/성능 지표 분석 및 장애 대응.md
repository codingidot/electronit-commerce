# STEP 20: 성능 지표 분석 및 장애 대응

## 1. 성능 지표 분석

### 1.1 쿠폰 발급 API (`POST /coupons/issue`)
- 총 요청: 1000
- 성공: 100 (선착순 100명)
- 실패: 900 (409 Conflict)
- 응답 시간
  - 평균: 2.26s
  - 최소: 0.0s
  - 최대: 6.18s
  - 95percentile: 5.75s
- 분석: 선착순 로직과 Redis 분산락 적용으로 경쟁 조건 방지, 일부 요청 지연은 DB/Kafka 처리 지연 영향

### 1.2 주문 처리 API (`POST /orders`)
- 총 요청: 1000
- 성공: 99 (재고 100개 기준)
- 실패: 901 (재고 부족)
- 응답 시간
  - 평균: 2.41s
  - 최소: 0.16s
  - 최대: 6.34s
  - 95percentile: 5.93s
- 분석: 트랜잭션, Redis 멀티락 등 주문 로직 정상 동작 확인, 실패율은 재고 한계 때문이며 정상 범위

## 2. 병목 탐색

- **DB**
  - 쿠폰 발급과 주문 처리 시 동시 요청이 많아 조회/업데이트 쿼리 지연
  - 인덱스 및 트랜잭션 처리 속도 최적화 필요
- **Kafka**
  - 주문 이벤트 전송 시 일부 요청 처리 지연 발생
  - 비동기 전송 및 배치 처리 고려 가능
- **Redis**
  - 순위 업데이트 및 TTL 확인 과정에서 약간의 지연 발생
  - 멀티락 적용으로 동시성 문제는 해결됨

## 3. 개선 사항

- 쿠폰 발급 수량 및 재고 확충 후 재시도 테스트
- 주문 처리 시 성공한 쿠폰 사용자만 처리하도록 로직 개선
- DB 쿼리 최적화 및 Kafka 전송 비동기화
- Redis TTL 및 멀티락 적용 로직 점검

## 4. 장애 대응 문서 (가상 시나리오)

### 4.1 장애 유형
- **DB 커넥션 부족**: 동시 요청 증가 시 커넥션 풀 고갈
- **Kafka 전송 지연**: 주문 이벤트 누락 가능
- **Redis Key 충돌**: 순위 업데이트 경쟁 발생

### 4.2 대응 방안
- DB 커넥션 풀 확장, 재시도 로직 추가
- Kafka 전송 비동기화 및 배치 처리
- Redis 분산락(MultiLock) 적용 유지, TTL 점검
- 모니터링: Scouter, Prometheus 등을 활용한 실시간 모니터링 및 알람 설정

### 4.3 테스트 시나리오
- 쿠폰 발급과 주문 처리 동시 부하 시, 일부 요청 실패 시 정상 롤백 확인
- DB/Kafka/Redis 지연 시 알람 발생 및 자동 재시도 확인
