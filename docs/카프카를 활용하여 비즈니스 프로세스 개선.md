# 카프카를 활용하여 비즈니스 프로세스 개선

## 1. 개요
대용량 트래픽을 처리하기 위해 기존 Redis 분산락 기반 쿠폰 발급 방식을 Kafka 기반 이벤트 처리로 개선했습니다.  
이를 통해 동시성, 확장성, DB 부하 관리 측면에서 개선 효과를 확인했습니다.

## 2. 개선 배경
- 기존 방식은 Redis 분산락으로 단일 서버에서 처리  
- 동시에 많은 사용자가 요청 시 Redis 락 경쟁 및 DB 트랜잭션 부하 발생  
- 서버 단일 처리 구조로 확장성 제한  

## 3. 개선 내용
- 쿠폰 발급을 Kafka 이벤트 발행 후 **비동기 처리** 구조로 변경  
- Kafka 토픽을 3개의 파티션으로 구성하여 병렬 처리 가능  
- Consumer에서 DB 트랜잭션 처리, Redis는 캐시 조회/감소 용도로만 사용  

### 3-1. 기존 vs 개선 비교

| 항목 | 기존 | 개선(Kafka) |
|------|------|-------------|
| 동시성 처리 | 단일 Redis 락 | Kafka 파티션 3개로 병렬 처리 |
| DB 트랜잭션 | 직접 처리 | Kafka Consumer에서 트랜잭션 처리 |
| 확장성 | 서버 단일 처리 | Consumer 수 증가로 수평 확장 가능 |
| 선착순 처리 | Redis decrement | Kafka 이벤트 순서 + DB 업데이트 |
| 처리 방식 | 동기 | 비동기 이벤트 발행 + Consumer 처리 |

### 3-2. Kafka 기반 비동기 처리 흐름
1. 사용자 요청 → `issueCouponWithKafka()` 호출  
2. DB 조회 후 `CouponIssueEvent` Kafka 토픽에 발행  
3. Kafka Consumer(`@KafkaListener`)가 이벤트 수신  
4. DB 트랜잭션 안에서 쿠폰 발급 처리(발급 수 증가, 사용자 쿠폰 기록 저장)  
5. 발급 결과는 이벤트 기반으로 비동기 처리  

### 3-3. Redis 분산락 비교

| 항목 | 기존 | 개선(Kafka) |
|------|------|-------------|
| 동시성 처리 | 단일 Redis 락 | Kafka 파티션 3개로 병렬 처리 |
| DB 트랜잭션 | 직접 처리 | Kafka Consumer에서 트랜잭션 처리 |
| 확장성 | 서버 단일 처리 | Consumer 수 증가로 수평 확장 가능 |
| 선착순 처리 | Redis decrement | Kafka 이벤트 순서 + DB 업데이트 |

## 4. 기대 효과
- **동시 요청 증가 시**에도 Kafka 토픽 3개 파티션을 활용하여 병렬 처리 가능  
- DB 과부하 감소, 서버 대기 시간 감소  
- 이벤트 기반 아키텍처로 **수평 확장 용이**  
- **비동기 처리**로 사용자 응답 지연 최소화  
- Redis는 캐시 조회/감소 용도로만 사용하여 DB 및 서버 부담 경감  

